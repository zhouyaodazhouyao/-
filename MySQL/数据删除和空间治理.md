#### 表数据存放位置

表数据既可以存在共享表空间里，也可以是单独的文件。由参数**innodb_file_per_table**控制：

- 设置为OFF时，表的数据存放在系统共享表空间，跟数据字典放在一起；
- 设置为ON时，每个InnoDB表数据存储在一个以.ibd为后缀的文件中；

[^注]: MySQL 5.6.6版本开始，默认值就是ON

设置为ON是推荐做法，因为每张表放在不同文件中，更容易管理，drop table时直接删除这个文件即可；反之如果存在共享表空间里，即使删除掉了，空间也不会回收。

#### 数据删除流程

删除一条记录时，InnoDB引擎会将这个记录标记为删除，后续如果有可以使用这个位置的记录新增进来，可以复用这个位置。同理，如果整个数据页上的记录都被删除了，那么这个数据页就可以复用了。不同的是，数据页可以复用到**其他任何位置**。

但是，即便被标记为删除，磁盘文件的**大小并没有发生变化**，这些位置就是**数据空洞**。不只删除数据会产生数据空洞，随机插入数据产生页分裂，也会产生数据空洞。

#### 重建表

为了去掉数据空洞，收缩表的大小，可以通过重建表来实现。需要注意的是，**重建并不会把整张表都占满，InnoDB给每个页都留了1/16的空间给后续更新用，重建之后也不是最紧凑的**。

- **使用alter table A engine=InnoDB**，该操作会建立一个和表A结构相同的表B，将A中的记录顺序插入表B，以达到收缩空间的目的。但是往临时表插入数据的过程中，表A不能有更新，否则会丢失数据，不能Online。
- **Online DDL**，先建立一个临时文件，扫描表A主键的所有数据页，用数据页中表A的记录生成B+树，存储到临时文件中；生成文件的过程中，所有对表A的操作，都记录在一个日志文件（**row log**）中，临时文件生成后，将日志文件中的操作应用到临时文件，得到逻辑数据和表A相同的数据文件；最后用临时文件替换表A的数据文件。

[^拓展]: Online DDL中，server层没有建临时表copy数据，数据直接进入InnoDB层的文件中，这个过程称之为inplace

